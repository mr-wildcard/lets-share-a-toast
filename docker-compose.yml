version: '3.8'

services:
  database:
    image: ${POSTGRES_DOCKER_IMAGE}
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_PORT}
    restart: always
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB

  pgadmin:
    image: ${PGADMIN_DOCKER_IMAGE}
    restart: always
    ports:
      - ${PGADMIN_LISTEN_PORT}:${PGADMIN_LISTEN_PORT}
    environment:
      - PGADMIN_DEFAULT_EMAIL
      - PGADMIN_DEFAULT_PASSWORD
      - PGADMIN_LISTEN_PORT
      - GUNICORN_ACCESS_LOGFILE

  api:
    image: ${NODE_DOCKER_IMAGE}
    command: /bin/sh -c "npm start -- api"
    volumes:
      - "./:/code:delegated"
    ports:
      - ${API_PORT}:${API_PORT}
    working_dir: /code
    environment:
      DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
      PORT: ${API_PORT}

  frontend:
    image: ${NODE_DOCKER_IMAGE}
    command: /bin/sh -c "npm start -- frontend -- --port ${FRONTEND_PORT}"
    volumes:
      - "./:/code:delegated"
    working_dir: /code
    ports:
      - ${FRONTEND_PORT}:${FRONTEND_PORT}
    environment:
      - API_URL=http://$APPS_LOCAL_DOMAIN:$NEST_API_PORT
      - REAL_TIME_APP_BASE_URL:http://$APPS_LOCAL_DOMAIN:?
      - REAL_TIME_SOCKET_ORIGINS:http://$APPS_LOCAL_DOMAIN:?
      - FIREBASE_API_KEY
      - FIREBASE_AUTH_DOMAIN
      - FIREBASE_DATABASE_URL
      - FIREBASE_PROJECT_ID
      - FIREBASE_STORAGE_BUCKET
      - FIREBASE_MESSAGING_SENDER_ID
      - FIREBASE_APP_ID
