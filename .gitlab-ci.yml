stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE_NAME: local-dev
  DOCKER_IMAGE_VERSION: 1.0.1
  DOCKER_IMAGE: "${CI_REGISTRY_IMAGE}/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_VERSION}"

image: $DOCKER_IMAGE

before_script:
  - yarn --immutable

cache:
  key:
    files:
      - yarn.lock
  paths:
    - "**/node_modules"
    - .yarn

test:web:
  stage: test
  tags: [ docker, ekino, france ]
  only:
    refs:
      - master
    changes:
      - web/**/*
  script:
    - NODE_ENV=production yarn workspace web build
  artifacts:
    paths:
      - firebase/dist
  variables:
    VITE_FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
    VITE_FIREBASE_API_KEY: ${FIREBASE_API_KEY}
    VITE_FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
    VITE_FIREBASE_APP_ID: ${FIREBASE_APP_ID}
    VITE_FIREBASE_DATABASE_URL: ${FIREBASE_DATABASE_URL}

test:functions:
  stage: test
  image: $DOCKER_IMAGE
  tags: [ docker, ekino, france ]
  only:
    refs:
      - master
    changes:
      - firebase/functions/**/*
  script:
    - yarn workspace functions build
  artifacts:
    paths:
      - firebase/functions/lib

preview:web:
  stage: deploy
  image: $DOCKER_IMAGE
  tags: [ docker, ekino, france ]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /^FIREBASE PREVIEW$/'
      changes:
        - web/**/*
  needs:
    - job: test:web
      artifacts: true
  script:
    - cd firebase
    - firebase hosting:channel:deploy $CI_COMMIT_REF_NAME
  variables:
    VITE_FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
    VITE_FIREBASE_API_KEY: ${FIREBASE_API_KEY}
    VITE_FIREBASE_AUTH_DOMAIN: ${FIREBASE_AUTH_DOMAIN}
    VITE_FIREBASE_APP_ID: ${FIREBASE_APP_ID}
    VITE_FIREBASE_DATABASE_URL: ${FIREBASE_DATABASE_URL}

deploy:web:
  stage: deploy
  image: $DOCKER_IMAGE
  tags: [ docker, ekino, france ]
  only:
    refs:
      - master
    changes:
      - web/**/*
  needs:
    - job: test:web
      artifacts: true
  before_script:
    - cd firebase
  script:
    - firebase deploy --only hosting

deploy:functions:
  stage: deploy
  image: $DOCKER_IMAGE
  tags: [ docker, ekino, france ]
  only:
    refs:
    - master
    changes:
    - firebase/functions/**/*
  needs:
    - job: test:functions
      artifacts: true
  script:
    - firebase deploy --only functions
